(  SELECT  CASE WHEN EXISTS (SELECT tplve._EXT_RS_DatZajMatOdhad  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID  AND ((tplve._EXT_RS_DatZajMatOdhad IS NULL AND tkz.SkupZbo NOT IN (N'605',N'666',N'100') AND tplv.RezijniMat=0)  AND tplv.RezijniMat=0  AND tplv.Sklad<>N'20000275900'  AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ))  THEN NULL  ELSE  (SELECT TOP 1 tplve._EXT_RS_DatZajMatOdhad  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID AND tkz.SkupZbo NOT IN (N'605',N'666',N'100')  AND tplv.RezijniMat=0   AND tplv.Sklad<>N'20000275900'  AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ORDER BY tplve._EXT_RS_DatZajMatOdhad DESC)  END  )      
