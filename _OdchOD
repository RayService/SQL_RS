ABS(  (((SELECT davka FROM TabDavka WITH(NOLOCK) WHERE (SELECT (SELECT D1.ID WHERE D1.ID IS NOT NULL UNION ALL SELECT D2.ID WHERE D2.ID IS NOT NULL) FROM TabKmenZbozi KZ LEFT OUTER JOIN TabZakazModifDilce ZMD ON (ZMD.IDZakazModif=TabPrikaz.IDZakazModif AND ZMD.IDKmenZbozi=KZ.ID AND ZMD.TPVModif=1) LEFT OUTER JOIN TabDavka D1 ON (ZMD.ID IS NULL AND D1.IDDilce=KZ.IDKusovnik AND D1.IDZakazModif IS NULL AND EXISTS(SELECT * FROM TabCZmeny ZodD LEFT OUTER JOIN TabCZmeny ZdoD ON (ZDoD.ID=D1.zmenaDo) WHERE ZodD.ID=D1.zmenaOd AND ZodD.platnost=1 AND TabPrikaz.DatumTPV>=ZodD.datum AND (D1.ZmenaDo IS NULL OR ZdoD.platnost=0 OR (ZdoD.platnost=1 AND TabPrikaz.DatumTPV<ZDoD.datum))) ) LEFT OUTER JOIN TabDavka D2 ON (ZMD.ID IS NOT NULL AND D2.IDDilce=KZ.ID AND D2.IDZakazModif=ZMD.IDZakazModif) WHERE KZ.ID=TabPrikaz.IDTabKmen) =TabDavka.ID)  -  TabPrikaz.kusy_ciste)  /  (SELECT davka FROM TabDavka WITH(NOLOCK) WHERE (SELECT (SELECT D1.ID WHERE D1.ID IS NOT NULL UNION ALL SELECT D2.ID WHERE D2.ID IS NOT NULL) FROM TabKmenZbozi KZ LEFT OUTER JOIN TabZakazModifDilce ZMD ON (ZMD.IDZakazModif=TabPrikaz.IDZakazModif AND ZMD.IDKmenZbozi=KZ.ID AND ZMD.TPVModif=1) LEFT OUTER JOIN TabDavka D1 ON (ZMD.ID IS NULL AND D1.IDDilce=KZ.IDKusovnik AND D1.IDZakazModif IS NULL AND EXISTS(SELECT * FROM TabCZmeny ZodD LEFT OUTER JOIN TabCZmeny ZdoD ON (ZDoD.ID=D1.zmenaDo) WHERE ZodD.ID=D1.zmenaOd AND ZodD.platnost=1 AND TabPrikaz.DatumTPV>=ZodD.datum AND (D1.ZmenaDo IS NULL OR ZdoD.platnost=0 OR (ZdoD.platnost=1 AND TabPrikaz.DatumTPV<ZDoD.datum))) ) LEFT OUTER JOIN TabDavka D2 ON (ZMD.ID IS NOT NULL AND D2.IDDilce=KZ.ID AND D2.IDZakazModif=ZMD.IDZakazModif) WHERE KZ.ID=TabPrikaz.IDTabKmen) =TabDavka.ID)  )*100)
