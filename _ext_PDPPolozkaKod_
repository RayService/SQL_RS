(CASE  WHEN EXISTS(SELECT * FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID) AND DatumUzavreni IS NULL)  THEN (SELECT Kod FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID AND IdHlavPDP=(SELECT TOP 1 ID FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP)   FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID) AND DatumUzavreni IS NULL))  WHEN EXISTS(SELECT * FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID)   AND DatumUzavreni=(SELECT max(DatumUzavreni) FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID)))  THEN (SELECT Kod FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID AND IdHlavPDP=(SELECT TOP 1 ID FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID)   AND DatumUzavreni=(SELECT max(DatumUzavreni) FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdPohybyZbozi=TabPohybyZbozi.ID))))  END)
