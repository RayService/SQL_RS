(CASE  WHEN EXISTS(SELECT * FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID) AND DatumUzavreni IS NULL)  THEN (SELECT ZakladDane FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID AND IdHlavPDP=(SELECT TOP 1 ID FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID) AND DatumUzavreni IS NULL))  WHEN EXISTS(SELECT * FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID)   AND DatumUzavreni=(SELECT max(DatumUzavreni) FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID)))  THEN (SELECT ZakladDane FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID AND IdHlavPDP=(SELECT TOP 1 ID FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID)   AND DatumUzavreni=(SELECT max(DatumUzavreni) FROM TabHlavickaPDP WHERE ID IN (SELECT DISTINCT(IdHlavPDP) FROM TabPolozkyPDP WHERE IdDenik=TabDenik.ID))))  END)
