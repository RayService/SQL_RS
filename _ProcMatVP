((TabPrKVazby.mat_real)  -  (CONVERT(numeric(19,6), ISNULL((SELECT TabPrKVazby.mnoz_zad * ISNULL(KC_M.cena,KC.cena) FROM TabKmenZbozi KZ WITH(NOLOCK) INNER JOIN TabPrikaz P WITH(NOLOCK) ON (P.ID=TabPrKVazby.IDPrikaz) LEFT OUTER JOIN TabKalkCe KC_M WITH(NOLOCK) ON (KC_M.IDKmenZbozi=KZ.ID AND KC_M.IDZakazModif=P.IDZakazModif) LEFT OUTER JOIN TabKalkCe KC WITH(NOLOCK) ON (KC_M.ID IS NULL AND KC.IDKmenZbozi=KZ.ID AND EXISTS(SELECT * FROM TabCZmeny ZodKC WITH(NOLOCK) LEFT OUTER JOIN TabCZmeny ZDoKC WITH(NOLOCK) ON (ZDoKC.ID=KC.zmenaDo) WHERE ZodKC.ID=KC.zmenaOd AND ZodKC.platnost=1 AND dbo.hf_TruncDate(ISNULL(P.Zadani,GETDATE()))>=ZodKC.datum AND (KC.ZmenaDo IS NULL OR ZdoKC.platnost=0 OR (ZDoKC.platnost=1 AND dbo.hf_TruncDate(ISNULL(P.Zadani,GETDATE()))<ZDoKC.datum)) ) ) WHERE KZ.ID=TabPrKVazby.nizsi AND KZ.Material=1 AND TabPrKVazby.VyraditZKalkulace=0), 0.0))))  /  ((CONVERT(numeric(19,6), ISNULL((SELECT TabPrKVazby.mnoz_zad * ISNULL(KC_M.cena,KC.cena) FROM TabKmenZbozi KZ WITH(NOLOCK) INNER JOIN TabPrikaz P WITH(NOLOCK) ON (P.ID=TabPrKVazby.IDPrikaz) LEFT OUTER JOIN TabKalkCe KC_M WITH(NOLOCK) ON (KC_M.IDKmenZbozi=KZ.ID AND KC_M.IDZakazModif=P.IDZakazModif) LEFT OUTER JOIN TabKalkCe KC WITH(NOLOCK) ON (KC_M.ID IS NULL AND KC.IDKmenZbozi=KZ.ID AND EXISTS(SELECT * FROM TabCZmeny ZodKC WITH(NOLOCK) LEFT OUTER JOIN TabCZmeny ZDoKC WITH(NOLOCK) ON (ZDoKC.ID=KC.zmenaDo) WHERE ZodKC.ID=KC.zmenaOd AND ZodKC.platnost=1 AND dbo.hf_TruncDate(ISNULL(P.Zadani,GETDATE()))>=ZodKC.datum AND (KC.ZmenaDo IS NULL OR ZdoKC.platnost=0 OR (ZDoKC.platnost=1 AND dbo.hf_TruncDate(ISNULL(P.Zadani,GETDATE()))<ZDoKC.datum)) ) ) WHERE KZ.ID=TabPrKVazby.nizsi AND KZ.Material=1 AND TabPrKVazby.VyraditZKalkulace=0), 0.0)))  +0.0001)  *100
