(SELECT  ISNULL((tzk.Celkem-tzk_bl.Celkem)/NULLIF(tzk_bl.Celkem,0),0)*100  FROM TabKmenZbozi tkz WITH (NOLOCK)  LEFT OUTER JOIN TabZKalkulace tzk WITH (NOLOCK) ON tzk.Dilec=tkz.ID AND EXISTS(SELECT * FROM TabCZmeny Zod WITH (NOLOCK) LEFT OUTER JOIN TabCZmeny Zdo WITH (NOLOCK) ON (ZDo.ID=tzk.zmenaDo)WHERE Zod.ID=tzk.zmenaOd AND Zod.platnostTPV=1 AND Zod.datum<=GETDATE() AND (tzk.ZmenaDo IS NULL OR Zdo.platnostTPV=0 OR (ZDo.platnostTPV=1 AND ZDo.datum>GETDATE())))   LEFT OUTER JOIN TabZKalkulace tzk_bl WITH (NOLOCK) ON tzk_bl.ID=(SELECT TOP 1 tzk.ID FROM TabZKalkulace tzk WITH (NOLOCK)  LEFT OUTER JOIN TabCzmeny tcz WITH (NOLOCK) ON tzk.ZmenaOd=tcz.ID  WHERE  ((tzk.IDZakazModif IS NULL)AND((tzk.Dilec=tkz.ID)))  AND tzk.ZmenaDo IS NOT NULL AND tzk.ZmenaOd IS NOT NULL  ORDER BY tzk.ID DESC)  WHERE tkz.ID=TabKmenZbozi.ID)
