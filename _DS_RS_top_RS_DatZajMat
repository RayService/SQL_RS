(SELECT CASE WHEN (SELECT tp.SkupinaPlanu              FROM TabPlan tp WITH (NOLOCK)             WHERE tp.ID=TabPlan.ID)=N'P100' THEN         (SELECT CASE WHEN EXISTS (          SELECT VVE._EXT_RS_DatZajMat          FROM TabPlanPrKVazby VV WITH(NOLOCK)          INNER JOIN TabPlanPrKVazby_EXT VVE WITH(NOLOCK) ON VV.ID = VVE.ID          LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=VV.nizsi          LEFT OUTER JOIN TabSkupinyZbozi tsz WITH(NOLOCK) ON tsz.SkupZbo=tkz.SkupZbo          LEFT OUTER JOIN TabSkupinyZbozi_EXT tsze WITH(NOLOCK) ON tsze.ID=tsz.ID          WHERE VV.IDPlan=TabPlan.ID AND tkz.SkupZbo LIKE N'93%' AND ISNULL(tsze._EXT_RS_vyraditP100SK,0)<>1 AND VVE._EXT_RS_DatZajMat IS NULL)         THEN NULL         ELSE         (SELECT MAX(VVE._EXT_RS_DatZajMat)          FROM TabPlanPrKVazby VV WITH(NOLOCK)          INNER JOIN TabPlanPrKVazby_EXT VVE WITH(NOLOCK) ON VV.ID = VVE.ID          LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=VV.nizsi          LEFT OUTER JOIN TabSkupinyZbozi tsz WITH(NOLOCK) ON tsz.SkupZbo=tkz.SkupZbo          LEFT OUTER JOIN TabSkupinyZbozi_EXT tsze WITH(NOLOCK) ON tsze.ID=tsz.ID          WHERE VV.IDPlan=TabPlan.ID AND tkz.SkupZbo LIKE N'93%' AND ISNULL(tsze._EXT_RS_vyraditP100SK,0)<>1)         END)        ELSE        (SELECT CASE WHEN EXISTS (          SELECT VE._EXT_RS_DatZajMat          FROM TabPlanPrKVazby V WITH(NOLOCK)          INNER JOIN TabPlanPrKVazby_EXT VE WITH(NOLOCK) ON V.ID = VE.ID          LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=V.nizsi          WHERE V.IDPlan=TabPlan.ID AND tkz.SkupZbo  LIKE N'93%' AND VE._EXT_RS_DatZajMat IS NULL)         THEN NULL         ELSE         (SELECT MAX(VE._EXT_RS_DatZajMat)         FROM TabPlanPrKVazby V WITH(NOLOCK)         INNER JOIN TabPlanPrKVazby_EXT VE WITH(NOLOCK) ON V.ID = VE.ID         LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=V.nizsi         WHERE V.IDPlan=TabPlan.ID AND tkz.SkupZbo  LIKE N'93%')         END)        END  )
