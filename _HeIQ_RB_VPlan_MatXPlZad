CAST(CASE   WHEN (SELECT  CASE WHEN EXISTS (SELECT tplve._DatZajMat  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID  AND ((tplve._DatZajMat IS NULL AND tkz.SkupZbo NOT IN (N'605',N'666',N'100') AND tplv.RezijniMat=0) AND tplv.RezijniMat=0 AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ))  THEN NULL  ELSE  (SELECT TOP 1 tplve._DatZajMat  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID AND tkz.SkupZbo NOT IN (N'605',N'666',N'100') AND tplv.RezijniMat=0 AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ORDER BY tplve._DatZajMat DESC)  END)  IS NULL THEN 13479887  WHEN (  (SELECT TOP 1 tplp.Plan_zadani_X  FROM TabPlanPrikaz tplp  LEFT OUTER JOIN TabPlan tp WITH (NOLOCK) ON tp.ID=tplp.IDPlan  WHERE tp.ID=TabPlan.ID  ORDER BY tplp.Plan_zadani_X DESC)  -10) <   (  SELECT  CASE WHEN EXISTS (SELECT tplve._DatZajMat  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID  AND ((tplve._DatZajMat IS NULL AND tkz.SkupZbo NOT IN (N'605',N'666',N'100') AND tplv.RezijniMat=0) AND tplv.RezijniMat=0 AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ))  THEN NULL  ELSE  (SELECT TOP 1 tplve._DatZajMat  FROM TabPlan tp WITH(NOLOCK)  LEFT OUTER JOIN TabPlanPrikaz tpp WITH(NOLOCK) ON tpp.IDPlan = tp.ID  LEFT OUTER JOIN TabPlanPrKVazby tplv WITH(NOLOCK) ON tplv.IDPlanPrikaz=tpp.ID  LEFT OUTER JOIN TabPlanPrKVazby_EXT tplve WITH(NOLOCK) ON tplve.ID=tplv.ID  LEFT OUTER JOIN TabKmenZbozi tkz WITH(NOLOCK) ON tkz.ID=tplv.nizsi  WHERE tp.ID=TabPlan.ID AND tkz.SkupZbo NOT IN (N'605',N'666',N'100') AND tplv.RezijniMat=0 AND tplv.ID NOT IN (SELECT tplv1.ID FROM TabPlanPrKVazby tplv1 INNER JOIN TabKmenZbozi K1 ON tplv1.nizsi = K1.ID WHERE K1.SkupZbo=150 AND K1.Dilec=1)  ORDER BY tplve._DatZajMat DESC)  END  )THEN 1065214  END AS INT)
