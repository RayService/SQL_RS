(SELECT CASE  WHEN (EXISTS(SELECT * FROM TabKategKontJed KTG WHERE TabKontaktJednani.Kategorie=KTG.Cislo AND KTG.QMSAgenda IN (0,1)))  -- Správa měřidel a Údržba strojů a zařízení  THEN  (  SELECT CASE  WHEN TabKontaktJednani.DatumJednaniDo IS NOT NULL  -- vyřazeno ze sledování  THEN NULL  WHEN   -- některé standardní úkoly mají prošlý termín zahájení / dokončení a jsou nezahájené a nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND   ( (u.TerminSplneni IS NOT NULL AND u.TerminSplneni < getdate() AND u.DatumDokonceni IS NULL) OR   (u.TerminZahajeni IS NOT NULL AND u.TerminSplneni IS NULL AND u.TerminZahajeni < getdate() AND (u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NULL)) )  )  THEN -2   WHEN   -- některé standardní úkoly nemají zadán termín zahájení ani dokončení a jsou nezahájené / nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.TerminZahajeni IS NULL AND u.TerminSplneni IS NULL AND u.DatumZahajeni IS NULL AND u.DatumDokonceni IS NULL  )  THEN -11  WHEN   -- existují nesplněné/nezahájené úkoly, které nemají prošlý termín zahájení / dokončení  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.DatumZahajeni IS NULL AND u.DatumDokonceni IS NULL   )  THEN -3  WHEN   -- existují zahájené nesplněné úkoly  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NOT NULL   )  THEN 0    ELSE NULL  END  )          WHEN (EXISTS(SELECT * FROM TabKategKontJed KTG WHERE TabKontaktJednani.Kategorie=KTG.Cislo AND KTG.QMSAgenda IN (4,5,7)))  -- Nápravná a preventivní opatření, Řízení auditů  THEN  (  SELECT CASE  WHEN TabKontaktJednani.Ukonceni IS NOT NULL  -- uzavřené opatření  THEN NULL  WHEN   -- některé úkoly mají prošlý termín dokončení a jsou nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.TerminSplneni IS NOT NULL AND u.TerminSplneni < getdate() AND u.DatumDokonceni IS NULL  )  THEN -2   WHEN   -- některé úkoly nemají zadán termín dokončení a jsou nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.TerminSplneni IS NULL AND u.DatumDokonceni IS NULL  )  THEN -11  WHEN   -- některé úkoly jsou nesplněné ani nezahájené, ale nemají prošlý termín  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND (u.TerminSplneni >= getdate() OR u.TerminSplneni IS NULL) AND u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NULL  )  THEN -3  WHEN   -- existují zahájené nesplněné úkoly, které nemají prošlý termín  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NOT NULL   )  THEN 0    ELSE NULL  END  )          WHEN (EXISTS(SELECT * FROM TabKategKontJed KTG WHERE TabKontaktJednani.Kategorie=KTG.Cislo AND KTG.QMSAgenda IN (2,3,6)))  -- Reklamace od odběratelů - pasivní, Reklamace vůči dodavatelům - aktivní, Interní neshody,   THEN  (  SELECT CASE  WHEN TabKontaktJednani.DatumJednaniDo IS NOT NULL  -- uzavřená reklamace  THEN NULL  WHEN   -- některé úkoly mají prošlý termín dokončení a jsou nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.TerminSplneni IS NOT NULL AND u.TerminSplneni < getdate() AND u.DatumDokonceni IS NULL  )  THEN -2   WHEN   -- některé úkoly nemají zadán termín dokončení a jsou nesplněné  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.TerminSplneni IS NULL AND u.DatumDokonceni IS NULL  )  THEN -11  WHEN   -- některé úkoly jsou nesplněné ani nezahájené, ale nemají prošlý termín  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND (u.TerminSplneni >= getdate() OR u.TerminSplneni IS NULL) AND u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NULL  )  THEN -3  WHEN   -- existují zahájené nesplněné úkoly, které nemají prošlý termín  EXISTS(  SELECT *  FROM TabUkoly u   WHERE u.IDKontaktJed = TabKontaktJednani.ID AND u.DatumDokonceni IS NULL AND u.DatumZahajeni IS NOT NULL   )  THEN 0    ELSE NULL  END  )        ELSE  -- Ostatni agendy  NULL  END  )
