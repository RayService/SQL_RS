(  DATEPART(WEEK,(  SELECT TOP 1 Datum  FROM (  (SELECT tpl.datum AS Datum  FROM TabPlan tpl WITH(NOLOCK)  WHERE tpl.ID=TabPlan.ID)  UNION  (SELECT Datum  FROM (SELECT  TOP 1 tp.Plan_ukonceni AS Datum  FROM TabPrikaz tp WITH(NOLOCK)  WHERE  (tp.ID IN (SELECT PrZ.IDPrikaz FROM TabPrikazZdrojVyrPlan PrZ WITH(NOLOCK) WHERE PrZ.IDPlan=TabPlan.ID))AND  (tp.StavPrikazu<=40)AND  (tp.kusy_zive>0)  ORDER BY tp.Plan_ukonceni DESC) AS T  )  UNION ALL  (SELECT Datum  FROM (SELECT  TOP 1 plpr.Plan_ukonceni AS Datum  FROM TabPlanPrikaz plpr WITH(NOLOCK)  LEFT OUTER JOIN TabPlan tpl WITH(NOLOCK) ON tpl.ID=plpr.IDPlan  WHERE  (plpr.IDPlan=TabPlan.ID)AND  (plpr.kusy_ciste>0)  ORDER BY plpr.Plan_ukonceni DESC) AS T  )  ) AS R  ORDER BY Datum DESC  ))  )
